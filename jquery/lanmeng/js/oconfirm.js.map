{"version":3,"sources":["oconfirm.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"oconfirm.js","sourcesContent":["\n/**\n * 收货地址相关\n * @return {[type]} [description]\n */\n(function () {\n  /**\n   * 验证插件加入pattern\n   */\n  $.validator.addMethod(\n    \"pattern\",\n    function(value, element, regexp) {\n        var re = new RegExp(regexp);\n        return this.optional(element) || re.test(value);\n    },\n    \"Please check your input.\"\n  );\n\n  /**\n   * 补充说明的字数限制\n   */\n  $('.oconfirm-panel5 .expanel .urow input').on('keyup keydown blur', function () {\n    var val = $(this).val();\n    if (val.length > 200) {\n      $(this).val(val.substring(0, 200));\n    }\n  });\n\n  /**\n   * 设置默认地址\n   */\n  var $oconfirm = $('#oconfirm');\n  $oconfirm.on('click', '.oconfirm-panel1 .item .setdefault', function () {\n    if ($(this).hasClass('disabled')) {\n      return false;\n    } else {\n      var self = this;\n      var $wrap = $(this).parent('.item');\n      $.post('/user/api/setdefaultaddress', {id: $wrap.attr('data-id')}).success(function (res) {\n        if (res.status !== 0) {\n          alert(res.tips);\n        } else {\n          $(self).text('默认地址').addClass('disabled');\n          $wrap.siblings().find('.setdefault').text('设置为默认地址').removeClass('disabled');\n        }\n      });\n    }\n  });\n\n  /**\n   * 选择当前地址\n   */\n  $oconfirm.on('click', '.oconfirm-panel1 .item', function () {\n    $(this).addClass('active').siblings().removeClass('active');\n  });\n\n  /**\n   * 省市区\n   */\n  var $province = $('#modal1 .province');\n  var $city = $('#modal1 .city');\n  var $district = $('#modal1 .district');\n\n  $province.on('change', function (evt, cId, dId) {\n    var id = $(this).val();\n    if (!id) return;\n    $.get('/user/api/city?id=' + id).success(function (res) {\n      var str = '<option value=\"\">--选择市--</option>';\n      $.each(res, function () {\n        str += '<option value=\"'+this.id+'\">'+this.name+'</option>';\n      });\n      $city.html(str);\n      $district.html('<option value=\"\">--选择区--</option>')\n      cId && $city.val(cId).trigger('change', dId);\n    });\n  });\n\n  $city.on('change', function (evt, dId) {\n    var id = $(this).val();\n    $.get('/user/api/city?id=' + id).success(function (res) {\n      var str = '<option value=\"\">--选择区--</option>';\n      $.each(res, function () {\n        str += '<option value=\"'+this.id+'\">'+this.name+'</option>';\n      });\n      $district.html(str);\n      dId && $district.val(dId);\n    });\n  });\n\n  /**\n   * 打开编辑收货地址模态\n   */\n  var $modal1 = $('#modal1')\n  $oconfirm.on('click', '.oconfirm-panel1 .item .edit', function () {\n    var $item = $(this).parent('.item');\n    $modal1\n      .find('.modal-header').text('新增收货地址').end()\n      .find('[name=\"id\"]').val($item.attr('data-id')).end()\n      .find('[name=\"consignee\"]').val($item.attr('data-consignee')).end()\n      .find('[name=\"province\"]').val($item.attr('data-province'))\n        .trigger('change', [$item.attr('data-city'), $item.attr('data-district')]).end()\n      .find('[name=\"address\"]').val($item.attr('data-address')).end()\n      .find('[name=\"zipcode\"]').val($item.attr('data-zipcode')).end()\n      .find('[name=\"mobile\"]').val($item.attr('data-mobile')).end()\n      .find('[name=\"phone\"]').val($item.attr('data-phone')).end()\n      .modal('show');\n  });\n\n  /**\n   * 打开新增收货地址模态\n   */\n  $oconfirm.on('click', '.panel-tt .addAddress', function () {\n    $modal1.find('form').get(0).reset();\n    $modal1.find('.modal-header').text('新增收货地址');\n    $modal1.modal('show');\n  });\n\n  /**\n   * 新增 && 编辑收货地址\n   */\n  $modal1.find('form').validate({\n    rules: {\n      consignee: {\n        required: true\n      },\n      province: {\n        required: true,\n        number: true\n      },\n      city: {\n        required: true,\n        number: true\n      },\n      district: {\n        required: true,\n        number: true\n      },\n      address: {\n        required: true\n      },\n      zipcode: {\n        required: true,\n        pattern: '^\\\\d{6}'\n      },\n      mobile: {\n        required: true,\n        pattern: '^1\\\\d{10}$'\n      }\n    },\n    messages: {\n      consignee: '收货人不能为空',\n      province: '请选择省&ensp;',\n      city: '请选择市&ensp;',\n      district: '请选择区&ensp;',\n      address: '详细地址不能为空',\n      zipcode: {\n        required: '邮编不能为空',\n        pattern: '请输入正确的邮编'\n      },\n      mobile: {\n        required: '手机号不能为空',\n        pattern: '请输入正确的手机号'\n      }\n    },\n    errorElement: 'span',\n    errorPlacement: function(err, elm) {\n      elm.parents('td').find('.help').append(err);\n    },\n    submitHandler: function(form) {\n      $.post($(form).find('[name=\"id\"]').val() ? '/user/api/modifyaddress' : '/user/api/addaddress', $(form).serialize())\n        .success(function (res) {\n          alert(res.tips);\n          if (res.status === 0) location.reload();\n        });\n    }\n  });\n\n  /**\n   * 支付方式\n   */\n  var $payType1 = $('.oconfirm-panel2 .item');\n  var $payType2 = $('.oconfirm-panel3 .item');\n\n  $payType1.add($payType2).on('click', function () {\n    if ($(this).hasClass('disabled')) return false;\n    $payType1.add($payType2).removeClass('active');\n    $(this).addClass('active');\n  });\n\n  /**\n   * 发票\n   */\n  var $invoice = $('.oconfirm-panel4 .item');\n  $invoice.on('click', '.ubtn', function () {\n    $invoice.toggleClass('active');\n  });\n\n\n})();\n\n\n/**\n * 折扣\n * @return {[type]} [description]\n */\n(function () {\n\n  var $amount = $('#price');\n  var $coupon = $('#coupon');\n  var $codeSave = $('#code_save');\n  var $allSave = $('#all_save');\n  var SCORE_RATIO = 50/1;\n  var $scoreTrf = $('#j_score_trf');\n  var $couponCodes = $('#couponCodes .ipt');\n  var $couponCheckboxs = $('.oconfirm-panel6 .tab-ct .i-couponId');\n  var couponTimer = null;\n  var amountSave = {\n    score: 0,\n    code: 0,\n    coupon: 0\n  };\n\n  // 积分抵扣\n  $('#j_score_crt').on('keydown keyup blur', function () {\n    var num = parseInt($(this).val());\n    var max = parseInt($(this).attr('data-max'));\n    var save = null;\n    num = $.isNumeric(num) ? num : 0;\n    num = num > max ? max : num;\n    save = (num/SCORE_RATIO).toFixed(2);\n    $(this).val(num);\n    $scoreTrf.html('&yen;'+save);\n    amountSave.score = parseFloat(save);\n    $amount.trigger('_save', amountSave);\n  });\n\n  // VIP抵金券\n  $couponCodes.on('keydown', function (evt) {//删除\n    var len = $(this).val().length;\n    if (len >= 4) $(this).next().focus();\n    if (len === 0 && evt.keyCode === 8) $(this).prev().focus();\n  }).on('keyup', function () {\n    var code = $couponCodes.map(function () {\n      return $(this).val();\n    }).toArray().join('');\n    if (code.length !== 16) {\n      amountSave.code = 0;\n      $codeSave.html('&yen;' + amountSave.code.toFixed(2));\n      $amount.trigger('_save', amountSave);\n    } else {\n      clearTimeout(couponTimer);\n      couponTimer = setTimeout(function () {\n        $codeSave.html('获取中，请稍候...');\n        $.post('/user/api/offlinecoupons', {code: code.toUpperCase()}).done(function (res) {\n          if (res.status === 0) {\n            amountSave.code = parseFloat(res.content.rmb);\n            $codeSave.html('&yen;' + amountSave.code.toFixed(2));\n            $amount.trigger('_save', amountSave);\n          } else {\n            $codeSave.html(res.tips);\n          }\n        })\n      }, 200);\n    }\n  });\n\n\n  // 优惠券tab\n  $coupon.on('click', '.tab-hd a', function () {\n    if ($(this).hasClass('active')) return;\n    $(this).addClass('active').siblings().removeClass('active');\n    $coupon.find('.tab-ct').removeClass('active').eq($(this).index()).addClass('active');\n  });\n\n  // 优惠券选中\n  $couponCheckboxs.on('change', function () {\n    $couponCheckboxs.not(this).prop('checked', false);\n    amountSave.coupon = $(this).is(':checked') ? parseFloat($(this).attr('data-save')) : 0;\n    $amount.trigger('_save', amountSave);\n  });\n\n  $amount.on('_save', function (evt, data) {\n    var save = data.score + data.code + data.coupon\n    var total = parseFloat($(this).attr('data-price')) - save;\n    if (total < 0) total = 0;\n    $allSave.html(save.toFixed(2));\n    $(this).html(total.toFixed(2));\n  });\n\n\n})();\n\n\n/**\n * 发票信息相关\n * @return {[type]} [description]\n */\n(function () {\n\n  /**\n   * 打开发票信息模态窗口\n   */\n  var $modal2 = $('#modal2');\n  $('.oconfirm-panel4 .item .edit').on('click', function () {\n    $modal2.modal('show');\n  });\n\n  /**\n   * 发票 省市区\n   */\n  var $province = $('#modal2 .province');\n  var $city = $('#modal2 .city');\n  var $district = $('#modal2 .district');\n\n  $province.on('change', function (evt, cId, dId) {\n    var id = $(this).val();\n    if (!id) return;\n    $.get('/user/api/city?id=' + id).success(function (res) {\n      var str = '<option value=\"\">--选择市--</option>';\n      $.each(res, function () {\n        str += '<option value=\"'+this.id+'\">'+this.name+'</option>';\n      });\n      $city.html(str);\n      $district.html('<option value=\"\">--选择区--</option>')\n      cId && $city.val(cId).trigger('change', dId);\n    });\n  });\n\n  $city.on('change', function (evt, dId) {\n    var id = $(this).val();\n    $.get('/user/api/city?id=' + id).success(function (res) {\n      var str = '<option value=\"\">--选择区--</option>';\n      $.each(res, function () {\n        str += '<option value=\"'+this.id+'\">'+this.name+'</option>';\n      });\n      $district.html(str);\n      dId && $district.val(dId);\n    });\n  });\n\n\n  /**\n   * 发票信息验证\n   */\n  var $form = $('#modal2 form');\n  $form.validate({\n    groups: {\n      area: 'province city dist'\n    },\n    rules: {\n      company: {\n        required: true\n      },\n      phone: {\n        required: true,\n        pattern: '^([0-9]{3,4}-)?[0-9]{7,8}$'\n      },\n      taxnum: {\n        required: true\n      },\n      bank: {\n        required: true\n      },\n      address: {\n        required: true\n      },\n      account: {\n        required: true\n      },\n      username: {\n        required: true\n      },\n      mobile: {\n        required: true,\n        pattern: '^1[0-9]{10}$'\n      },\n      province: {\n        required: true\n      },\n      city: {\n        required: true\n      },\n      dist: {\n        required: true\n      },\n      adddress: {\n        required: true\n      }\n    },\n    messages: {\n      company: '公司地址不能为空',\n      phone: {\n        required: '手机号不能为空',\n        pattern: '手机号码格式错误'\n      },\n      taxnum: '纳税人识别码不能为空',\n      bank: '开户行不能为空',\n      address: '公司地址不能为空',\n      account: '银行账号不能为空',\n      username: '收票人不能为空',\n      mobile: {\n        required: '收票人手机不能为空',\n        pattern: '手机号码格式错误'\n      },\n      adddress: '详细地址不能为空',\n      province: '请选择省市区',\n      city: '请选择省市区',\n      dist: '请选择省市区',\n    },\n    errorElement: 'div',\n    errorPlacement: function (err, elm) {\n      $(elm).parents('td').find('.help').append(err);\n    },\n    submitHandler: function(form) {\n      var id = $(form).find('[name=\"id\"]').val();\n      $.post('/user/api/' + (id ? 'modifyinvoice' : 'invoice'), $(form).serialize())\n        .success(function (res) {\n          alert(res.tips);\n          if (res.status === 0) {\n            window.location.reload();\n            // $modal2.modal('hide');\n            // console.log($('.oconfirm-panel4 .item .name'));\n            // $('.oconfirm-panel4 .item .name').text( $(form).find('[name=\"company\"]').val() );\n          }\n        });\n    }\n  });\n\n\n})();\n\n\n/**\n * 提交订单\n * @return {[type]} [description]\n */\n(function () {\n\n  var $submitBtn = $('#submitBtn');\n  var $payType = $('.oconfirm-panel2 .item, .oconfirm-panel3 .item');\n  var $invoice = $('.oconfirm-panel4 .item');\n\n  var defer_submit = null;\n\n\n\n\n\n  $submitBtn.on('click', function () {\n    var $self = $(this);\n    if ($self.hasClass('pending')) return;\n    $self.addClass('pending');\n\n    var params = {};\n    params.incoice = $invoice.hasClass('active') ? $invoice.attr('data-id') : 0;\n    if (params.incoice == 0 && confirm('发票信息未填写，如需增值税发票，请点”是“完善发票信息')) {\n      $('#modal2').modal('show');\n      $self.removeClass('pending');\n      return;\n    }\n    params.rid = $('.oconfirm-panel1 .item.active').attr('data-id');\n    params.pay = $payType.filter('.active').attr('data-id');\n    params.orderprice = 0;\n    params.dispatch = $('.oconfirm-panel5 .dispatch').map(function () {\n      return $(this).val();\n    }).toArray().join(',');\n    params.score = $('#j_score_crt').val();\n    params.couponCode = $('#couponCodes input').map(function () {\n      return $(this).val();\n    }).toArray().join('');\n    params.exMsg = $('#exMsg').val();\n    params.couponId = $('.oconfirm-panel6 .tab-ct .i-couponId:checked').val();\n\n    load($.post('/user/api/ocorder', $.param(params)))\n      .done(function (res) {\n        if (res.status === 0) {\n          if (res.url != '') {\n            window.location.href = res.url;\n          } else {\n            window.location.href = '/order?id=' + res.content.ordersn;\n          }\n        } else {\n          alert(res.tips);\n        }\n      })\n      .always(function () {\n        $self.removeClass('pending');\n      });\n  });\n\n\n\n})();\n"],"sourceRoot":"/source/"}